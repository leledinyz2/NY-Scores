<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Criador de Pontuações - Lele</title>
  <style>
    :root{--bg:#0f1720;--card:#0b1220;--accent:#ff4f8b;--muted:#9aa4b2}
    body{font-family:Inter,system-ui,Arial;margin:0;background:linear-gradient(180deg,var(--bg),#071019);color:#e6eef6}
    header{background:var(--accent);color:#111;padding:14px 16px;font-weight:700;text-align:center}
    .wrap{max-width:1100px;margin:18px auto;padding:12px}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
    form{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    label{font-size:13px;color:var(--muted)}
    input,select,button,textarea{padding:8px;border-radius:8px;border:1px solid #1f2a37;background:#0b1220;color:#e6eef6}
    input[type=number]{width:110px}
    .grow{flex:1;min-width:160px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px 10px;border-bottom:1px solid #0e1a26;text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:600}
    tr:hover{background:rgba(255,255,255,0.02)}
    .btn{background:var(--accent);color:#111;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid #2b3a49;color:var(--muted)}
    .small{padding:6px 8px;font-size:13px}
    .muted{color:var(--muted);font-size:13px}
    .flex{display:flex;gap:8px;align-items:center}
    .actions button{margin-right:6px}
    .empty{padding:18px;text-align:center;color:var(--muted)}
    @media (max-width:760px){ form{flex-direction:column;align-items:stretch} .flex {flex-direction:column;align-items:stretch} }
  </style>
</head>
<body>
  <header>Criador de Pontuações — Monta sua ficha do zero</header>
  <div class="wrap">
    <div class="card">
      <h3 style="margin:4px 0 8px 0">Adicionar música</h3>
      <form id="formNova">
        <input id="inputMusica" class="grow" placeholder="Nome da música (obrigatório)" required>
        <input id="inputVersao" placeholder="Versão (ex: Club, Remix)" style="width:180px">
        <input id="inputPontuacao" type="number" min="0" placeholder="Pontuação" style="width:120px">
        <select id="inputEstrelas">
          <option value="">Estrelas</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
        <input id="inputJogo" placeholder="Jogo (ex: Just Dance 2017)" style="width:160px">

        <div class="controls">
          <button type="submit" class="btn">Adicionar</button>
          <button type="button" id="limparForm" class="btn ghost small">Limpar</button>
        </div>
      </form>

      <div style="margin-top:12px" class="muted">Os dados são salvos localmente no seu navegador (localStorage). Você pode exportar como CSV/JSON para compartilhar ou importar de volta.</div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="flex" style="justify-content:space-between">
        <h3 style="margin:6px 0">Sua lista</h3>
        <div class="actions">
          <button id="exportJson" class="btn small">Exportar JSON</button>
          <button id="exportCsv" class="btn small">Exportar CSV</button>
          <label class="btn small ghost" style="display:inline-block;cursor:pointer">
            Importar JSON<input id="importFile" type="file" accept="application/json" style="display:none">
          </label>
          <button id="copyUrl" class="btn small ghost">Gerar link (copiar)</button>
          <button id="clearAll" class="btn ghost small">Limpar tudo</button>
        </div>
      </div>

      <table id="tabela">
        <thead>
          <tr><th>Música</th><th>Versão</th><th>Pontuação</th><th>Estrelas</th><th>Jogo</th><th></th></tr>
        </thead>
        <tbody id="tbody">
          <tr class="empty"><td colspan="6">Nenhuma música adicionada. Use o formulário acima para criar sua ficha.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // storage key
    const STORAGE_KEY = 'jd_custom_sheet_v1';

    // DOM
    const form = document.getElementById('formNova');
    const inputMusica = document.getElementById('inputMusica');
    const inputVersao = document.getElementById('inputVersao');
    const inputPontuacao = document.getElementById('inputPontuacao');
    const inputEstrelas = document.getElementById('inputEstrelas');
    const inputJogo = document.getElementById('inputJogo');
    const tbody = document.getElementById('tbody');
    const exportJsonBtn = document.getElementById('exportJson');
    const exportCsvBtn = document.getElementById('exportCsv');
    const importFile = document.getElementById('importFile');
    const copyUrlBtn = document.getElementById('copyUrl');
    const clearAllBtn = document.getElementById('clearAll');
    const limparFormBtn = document.getElementById('limparForm');

    let dados = [];

    // util
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(dados)); }
    function load(){ try{ const raw = localStorage.getItem(STORAGE_KEY); dados = raw? JSON.parse(raw): []; }catch(e){ dados=[] } }

    function render(){
      tbody.innerHTML = '';
      if(dados.length===0){ tbody.innerHTML = '<tr class="empty"><td colspan="6">Nenhuma música adicionada. Use o formulário acima para criar sua ficha.</td></tr>'; return; }
      dados.forEach((item,idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(item.musica)}</td>
          <td>${escapeHtml(item.versao||'')}</td>
          <td>${escapeHtml(item.pontuacao||'')}</td>
          <td>${escapeHtml(item.estrelas||'')}</td>
          <td>${escapeHtml(item.jogo||'')}</td>
          <td style="text-align:right">
            <button class="btn small ghost" data-idx="${idx}" data-action="edit">Editar</button>
            <button class="btn small ghost" data-idx="${idx}" data-action="del">Excluir</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    form.addEventListener('submit', e=>{
      e.preventDefault();
      const musica = inputMusica.value.trim();
      if(!musica) return alert('Coloca o nome da música!');
      const item = {
        musica,
        versao: inputVersao.value.trim(),
        pontuacao: inputPontuacao.value? Number(inputPontuacao.value): '',
        estrelas: inputEstrelas.value || '',
        jogo: inputJogo.value.trim()
      };
      dados.push(item); save(); render(); form.reset(); inputMusica.focus();
    });

    limparFormBtn.addEventListener('click', ()=>{ form.reset(); inputMusica.focus(); });

    tbody.addEventListener('click', e=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const idx = Number(btn.getAttribute('data-idx'));
      const action = btn.getAttribute('data-action');
      if(action==='del'){
        if(!confirm('Excluir esta música?')) return;
        dados.splice(idx,1); save(); render();
      }else if(action==='edit'){
        const it = dados[idx];
        inputMusica.value = it.musica; inputVersao.value = it.versao; inputPontuacao.value = it.pontuacao; inputEstrelas.value = it.estrelas; inputJogo.value = it.jogo;
        // remove original and allow resubmit
        dados.splice(idx,1); save(); render(); inputMusica.focus();
      }
    });

    // export JSON
    exportJsonBtn.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(dados, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'jd_scores.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // export CSV
    function toCSV(arr){
      if(!arr.length) return ''; const headers = ['Música','Versão','Pontuação','Estrelas','Jogo'];
      const esc = v => '"'+String(v||'').replace(/"/g,'""')+'"';
      const lines = [headers.map(esc).join(',')];
      arr.forEach(r=> lines.push([r.musica,r.versao,r.pontuacao,r.estrelas,r.jogo].map(esc).join(',')));
      return lines.join('
');
    }
    exportCsvBtn.addEventListener('click', ()=>{
      const csv = toCSV(dados);
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'jd_scores.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // import JSON
    importFile.addEventListener('change', e=>{
      const f = e.target.files[0]; if(!f) return; const reader = new FileReader();
      reader.onload = ev => {
        try{ const parsed = JSON.parse(ev.target.result); if(!Array.isArray(parsed)) throw new Error('Formato inválido');
          // normalize
          parsed.forEach(it=>{ it.musica = it.musica||it.Música||it.song||''; it.versao = it.versao||it.Versão||it.version||''; it.pontuacao = it.pontuacao||it.Pontuação||it.score||''; it.estrelas = it.estrelas||it.Estrelas||''; it.jogo = it.jogo||it.Jogo||it.game||''; });
          dados = parsed.filter(x=>x.musica && x.musica.trim()!==''); save(); render();
        }catch(err){ alert('Erro ao importar JSON: '+err.message); }
      };
      reader.readAsText(f);
      e.target.value = '';
    });

    // copy as shareable URL (data encoded in URL hash)
    copyUrlBtn.addEventListener('click', ()=>{
      const payload = encodeURIComponent(JSON.stringify(dados));
      const url = location.origin + location.pathname + '#data=' + payload;
      navigator.clipboard.writeText(url).then(()=> alert('Link copiado! Cola onde quiser para compartilhar (dados ficam no link).'))
        .catch(()=> alert('Não foi possível copiar. Exporta o JSON em vez disso.'));
    });

    // clear all
    clearAllBtn.addEventListener('click', ()=>{ if(confirm('Limpar toda a lista?')){ dados=[]; save(); render(); } });

    // load from URL hash (import via link)
    function loadFromHash(){
      if(location.hash && location.hash.startsWith('#data=')){
        try{ const raw = decodeURIComponent(location.hash.slice(6)); const parsed = JSON.parse(raw); if(Array.isArray(parsed)){ dados = parsed; save(); render(); setTimeout(()=>alert('Dados importados do link!'),200); }
        }catch(e){ console.warn('hash import falhou', e); }
      }
    }

    // init
    load(); loadFromHash(); render();
  </script>
  <div class="loader-section">
    <h2>Carregar dados de uma planilha</h2>
    <input id="sheetUrl" type="text" placeholder="Cole aqui o link da planilha CSV ou Google Sheets (CSV)">
    <button id="loadSheet">Carregar</button>
  </div>

  <script>
    async function loadFromURL(url){
      try{
        const response = await fetch(url);
        const text = await response.text();
        const rows = text.split(/
?
/).map(r=>r.split(","));
        rows.forEach(r=>{
          if(r.length>=2 && r[0].trim()!==""){
            addMusic(r[0], r[1]);
          }
        });
        alert("Planilha carregada com sucesso!");
      }catch(err){
        alert("Erro ao carregar: "+ err.message);
      }
    }

    document.getElementById("loadSheet").onclick = ()=>{
      const url = document.getElementById("sheetUrl").value.trim();
      if(!url){ alert("Cole um link primeiro!"); return; }
      loadFromURL(url);
    };
  </script>
</body>
</html>
